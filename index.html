import React, { useEffect, useMemo, useRef, useState } from "react";
import { motion } from "framer-motion";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardFooter, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Switch } from "@/components/ui/switch";
import { Slider } from "@/components/ui/slider";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { Check, ChevronRight, Clock, Download, HelpCircle, History, RefreshCcw, Settings, X } from "lucide-react";

/**
 * 초등 수학 문제 맞추기 (Single-file React)
 * - 모드: 사칙연산, 구구단, 비교(>, <, =), 혼합
 * - 난이도: 자리수/범위 슬라이더
 * - 시간제한 모드, 즉시 채점, 힌트, 오답노트, 연속정답(스트릭)
 * - 로컬 저장: 설정/히스토리/오답노트
 * - 결과 내보내기: CSV
 *
 * Tailwind + shadcn/ui + framer-motion 사용
 */

type Mode = "arithmetic" | "multiplication" | "compare" | "mixed";

type Problem = {
  id: string;
  text: string; // 표시용
  answer: number | string; // 비교 모드에서 '=' 포함 가능
  meta: {
    a?: number;
    b?: number;
    op?: "+" | "-" | "×" | "÷";
    mode: Mode;
    range: number;
  };
};

type HistoryItem = {
  id: string;
  text: string;
  user: string;
  correct: boolean;
  answer: string | number;
  timeMs: number;
  ts: number; // epoch ms
};

type SettingsState = {
  mode: Mode;
  range: number; // 최대 수 범위 (10~9999)
  allowNegative: boolean; // 뺄셈에서 음수 결과 허용
  timeLimit: boolean;
  secondsPerQ: number; // 문제당 제한시간
  instantCheck: boolean; // 입력 즉시 채점
  questionCount: number; // 세트 문제 수
};

const DEFAULT_SETTINGS: SettingsState = {
  mode: "mixed",
  range: 50,
  allowNegative: false,
  timeLimit: false,
  secondsPerQ: 20,
  instantCheck: true,
  questionCount: 10,
};

const STORAGE_KEYS = {
  settings: "mathquiz_settings_v1",
  history: "mathquiz_history_v1",
  wrongbook: "mathquiz_wrongbook_v1",
} as const;

function saveLocal<T>(key: string, value: T) {
  try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
}
function loadLocal<T>(key: string, fallback: T): T {
  try {
    const raw = localStorage.getItem(key);
    return raw ? (JSON.parse(raw) as T) : fallback;
  } catch { return fallback; }
}

function rng(max: number) { return Math.floor(Math.random() * (max + 1)); }
function pick<T>(arr: T[]): T { return arr[Math.floor(Math.random() * arr.length)]; }

function makeId() { return Math.random().toString(36).slice(2, 10); }

function generateArithmetic(range: number, allowNegative: boolean): Problem {
  const ops: Array<"+"|"-"|"×"|"÷"> = ["+","-","×","÷"];
  const op = pick(ops);
  let a = rng(range);
  let b = rng(range);
  if (op === "÷") {
    // 나눗셈: 나누어떨어지도록 구성
    b = Math.max(1, rng(Math.max(1, Math.floor(range/3))));
    a = b * rng(Math.max(1, Math.floor(range/3)));
  }
  if (op === "-" && !allowNegative && a < b) [a, b] = [b, a];
  const text = `${a} ${op} ${b}`;
  let answer: number;
  switch (op) {
    case "+": answer = a + b; break;
    case "-": answer = a - b; break;
    case "×": answer = a * b; break;
    case "÷": answer = b === 0 ? 0 : a / b; break;
  }
  return { id: makeId(), text, answer, meta: { a, b, op, mode: "arithmetic", range } };
}

function generateMultiplication(range: number): Problem {
  const a = rng(Math.max(2, Math.min(9, range)));
  const b = rng(Math.max(2, Math.min(9, range)));
  const text = `${a} × ${b}`;
  return { id: makeId(), text, answer: a*b, meta: { a, b, op: "×", mode: "multiplication", range } };
}

function generateCompare(range: number): Problem {
  const a = rng(range);
  const b = rng(range);
  let answer: ">" | "<" | "=" = a>b?">": a<b?"<":"=";
  const text = `${a}  [ ?, >, <, = ]  ${b}`;
  return { id: makeId(), text, answer, meta: { a, b, mode: "compare", range } };
}

function generateProblem(st: SettingsState): Problem {
  const mode = st.mode === "mixed" ? pick(["arithmetic","multiplication","compare"]) : st.mode;
  if (mode === "arithmetic") return generateArithmetic(st.range, st.allowNegative);
  if (mode === "multiplication") return generateMultiplication(st.range);
  if (mode === "compare") return generateCompare(st.range);
  return generateArithmetic(st.range, st.allowNegative);
}

function toCSV(rows: Array<Record<string,string|number>>): string {
  const keys = Object.keys(rows[0] ?? {});
  const esc = (v: any) => `"${String(v).replaceAll("\"","\"\"")}"`;
  return [keys.join(","), ...rows.map(r => keys.map(k => esc(r[k] ?? "")).join(","))].join("\n");
}

const Pill: React.FC<{children: React.ReactNode, className?: string}> = ({children, className}) => (
  <span className={`px-2 py-0.5 rounded-full text-xs border bg-white/5 ${className??""}`}>{children}</span>
);

export default function App() {
  const [settings, setSettings] = useState<SettingsState>(() => loadLocal(STORAGE_KEYS.settings, DEFAULT_SETTINGS));
  const [current, setCurrent] = useState<Problem>(() => generateProblem(DEFAULT_SETTINGS));
  const [user, setUser] = useState("");
  const [count, setCount] = useState(0);
  const [correctCount, setCorrectCount] = useState(0);
  const [streak, setStreak] = useState(0);
  const [history, setHistory] = useState<HistoryItem[]>(() => loadLocal(STORAGE_KEYS.history, [] as HistoryItem[]));
  const [wrongbook, setWrongbook] = useState<HistoryItem[]>(() => loadLocal(STORAGE_KEYS.wrongbook, [] as HistoryItem[]));
  const [secondsLeft, setSecondsLeft] = useState(settings.secondsPerQ);
  const [running, setRunning] = useState(false);
  const [input, setInput] = useState("");
  const [showResult, setShowResult] = useState(false);
  const [lastItem, setLastItem] = useState<HistoryItem|undefined>(undefined);
  const inputRef = useRef<HTMLInputElement>(null);
  const startedAtRef = useRef<number>(Date.now());

  // 지속 저장
  useEffect(() => saveLocal(STORAGE_KEYS.settings, settings), [settings]);
  useEffect(() => saveLocal(STORAGE_KEYS.history, history), [history]);
  useEffect(() => saveLocal(STORAGE_KEYS.wrongbook, wrongbook), [wrongbook]);

  // 타이머
  useEffect(() => {
    if (!running || !settings.timeLimit) return;
    setSecondsLeft(settings.secondsPerQ);
    const t = setInterval(() => setSecondsLeft(s => s-1), 1000);
    return () => clearInterval(t);
  }, [current.id, running, settings.timeLimit, settings.secondsPerQ]);

  useEffect(() => {
    if (!running || !settings.timeLimit) return;
    if (secondsLeft <= 0) {
      handleSubmit(true); // 시간초과는 오답 처리
    }
  }, [secondsLeft]);

  useEffect(() => { if (running) inputRef.current?.focus(); }, [running, current.id]);

  const accuracy = useMemo(() => count===0?0:Math.round((correctCount/count)*100), [count, correctCount]);

  function nextProblem(resetTimer=true) {
    setCurrent(generateProblem(settings));
    setInput("");
    if (resetTimer && settings.timeLimit) setSecondsLeft(settings.secondsPerQ);
    startedAtRef.current = Date.now();
  }

  function normalizeUserInput(): string {
    const raw = input.trim();
    if (current.meta.mode === "compare") {
      if ([">","<","="].includes(raw)) return raw;
      if (["gt","greater","크다"].includes(raw.toLowerCase())) return ">";
      if (["lt","less","작다"].includes(raw.toLowerCase())) return "<";
      if (["eq","equal","같다","="] as string[]).includes(raw.toLowerCase())) return "=";
      return raw;
    }
    // 숫자만 남기기(부호, 소수점 허용)
    return raw.replace(/[\s,]/g, "");
  }

  function checkCorrect(userAnswer: string): boolean {
    if (current.meta.mode === "compare") return userAnswer === String(current.answer);
    const num = Number(userAnswer);
    return Number.isFinite(num) && Math.abs(num - Number(current.answer)) < 1e-9;
  }

  function handleSubmit(timeout=false) {
    const elapsed = Date.now() - startedAtRef.current;
    const userAnswer = timeout? "(시간초과)" : normalizeUserInput();
    const correct = !timeout && checkCorrect(userAnswer);

    const item: HistoryItem = {
      id: current.id,
      text: current.text,
      user: userAnswer,
      correct,
      answer: current.answer,
      timeMs: elapsed,
      ts: Date.now(),
    };

    setHistory(h => [item, ...h].slice(0, 2000));
    if (!correct) setWrongbook(w => [item, ...w].slice(0, 1000));

    setCount(c => c+1);
    setCorrectCount(c => c + (correct?1:0));
    setStreak(s => correct? s+1 : 0);
    setLastItem(item);
    setShowResult(true);

    // 다음 문제 예열
    setTimeout(() => {
      setShowResult(false);
      nextProblem();
    }, 700);
  }

  function startSession() {
    setRunning(true);
    setCount(0);
    setCorrectCount(0);
    setStreak(0);
    nextProblem();
  }

  function stopSession() { setRunning(false); }

  function onInstantInput(val: string) {
    setInput(val);
    if (settings.instantCheck && running) {
      const ok = checkCorrect(val.trim());
      if (ok) handleSubmit(false);
    }
  }

  function downloadCSV() {
    if (history.length === 0) return;
    const rows = history.map((h,i) => ({
      idx: history.length - i,
      when: new Date(h.ts).toLocaleString(),
      text: h.text,
      user: h.user,
      correct: h.correct ? "O" : "X",
      answer: h.answer,
      time_ms: h.timeMs,
    }));
    const csv = toCSV(rows);
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `mathquiz_${Date.now()}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function redoWrong() {
    if (wrongbook.length === 0) return;
    const w = wrongbook[0];
    // 간단 복원: 텍스트 파싱 (학습용)
    let p: Problem | null = null;
    if (String(w.answer) === ">" || String(w.answer) === "<" || String(w.answer) === "=") {
      p = { id: makeId(), text: w.text, answer: w.answer, meta: { mode: "compare", range: settings.range } } as Problem;
    } else {
      p = { id: makeId(), text: w.text, answer: Number(w.answer), meta: { mode: "arithmetic", range: settings.range } } as Problem;
    }
    setCurrent(p);
    setInput("");
    setRunning(true);
    startedAtRef.current = Date.now();
  }

  return (
    <div className="min-h-screen w-full bg-gradient-to-br from-sky-900 via-slate-900 to-indigo-950 text-slate-100 p-4 md:p-8">
      <div className="max-w-5xl mx-auto grid gap-4 md:gap-6">
        <header className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <Badge variant="secondary" className="bg-white/10">초등 수학</Badge>
            <h1 className="text-2xl md:text-3xl font-bold">문제 맞추기</h1>
            <Pill>v1.0</Pill>
          </div>
          <div className="flex items-center gap-2">
            <Button size="sm" variant="secondary" onClick={downloadCSV}>
              <Download className="w-4 h-4 mr-2"/>기록 내보내기
            </Button>
            <Button size="sm" variant="secondary" onClick={() => redoWrong()} disabled={wrongbook.length===0}>
              <History className="w-4 h-4 mr-2"/>오답 다시풀기 ({wrongbook.length})
            </Button>
          </div>
        </header>

        {/* 대시보드 */}
        <div className="grid md:grid-cols-3 gap-4">
          <Card className="bg-white/5 border-white/10 md:col-span-2">
            <CardHeader className="pb-2">
              <CardTitle className="flex items-center gap-2"><Clock className="w-5 h-5"/>진행판</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex flex-wrap items-center gap-2 text-sm text-slate-300">
                <Pill>문제 수: {count}</Pill>
                <Pill>정답: {correctCount}</Pill>
                <Pill>정확도: {accuracy}%</Pill>
                <Pill>연속 정답: {streak}</Pill>
                {settings.timeLimit && (
                  <Pill className={secondsLeft<=5?"bg-red-500/20 border-red-500/40 text-red-100":""}>
                    남은 시간: {secondsLeft}s
                  </Pill>
                )}
              </div>

              {/* 문제 카드 */}
              <motion.div layout initial={{opacity:0, y:10}} animate={{opacity:1, y:0}} key={current.id}>
                <Card className="bg-slate-900/60 border-white/10">
                  <CardContent className="py-8">
                    <div className="text-center">
                      <div className="text-sm uppercase tracking-widest text-slate-400 mb-2">현재 문제</div>
                      <div className="text-4xl md:text-6xl font-extrabold drop-shadow">
                        {current.text}
                      </div>
                      <div className="mt-6 flex items-center justify-center gap-2">
                        {current.meta.mode === "compare" ? (
                          <Select value={input} onValueChange={onInstantInput}>
                            <SelectTrigger className="w-40">
                              <SelectValue placeholder="정답 선택" />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value=">">{">"}</SelectItem>
                              <SelectItem value="=">{"="}</SelectItem>
                              <SelectItem value="<">{"<"}</SelectItem>
                            </SelectContent>
                          </Select>
                        ) : (
                          <Input
                            ref={inputRef}
                            inputMode="numeric"
                            placeholder="답을 입력하세요"
                            value={input}
                            onChange={e => onInstantInput(e.target.value)}
                            onKeyDown={(e) => { if (e.key === "Enter") handleSubmit(false); }}
                            className="text-center text-2xl max-w-xs mx-auto"
                          />
                        )}
                      </div>

                      <div className="mt-4 flex items-center justify-center gap-2">
                        <Button onClick={() => handleSubmit(false)} className="gap-2"><Check className="w-4 h-4"/>제출</Button>
                        <Button variant="secondary" onClick={() => nextProblem()} className="gap-2"><RefreshCcw className="w-4 h-4"/>다른문제</Button>
                      </div>
                    </div>
                  </CardContent>

                  {showResult && lastItem && (
                    <CardFooter className="border-t border-white/10 bg-black/20">
                      <div className="w-full flex items-center justify-between text-sm">
                        <div className={`flex items-center gap-2 ${lastItem.correct?"text-emerald-300":"text-rose-300"}`}>
                          {lastItem.correct ? <Check className="w-4 h-4"/> : <X className="w-4 h-4"/>}
                          {lastItem.correct ? "정답!" : `오답: 정답은 ${lastItem.answer}`}
                        </div>
                        <div className="text-slate-300">소요: {(lastItem.timeMs/1000).toFixed(1)}s</div>
                      </div>
                    </CardFooter>
                  )}
                </Card>
              </motion.div>

              <div className="flex items-center justify-between">
                {!running ? (
                  <Button size="lg" onClick={startSession} className="gap-2"><ChevronRight className="w-5 h-5"/>시작</Button>
                ) : (
                  <Button size="lg" variant="destructive" onClick={stopSession} className="gap-2"><X className="w-5 h-5"/>종료</Button>
                )}
                <div className="text-xs text-slate-400 flex items-center gap-2"><HelpCircle className="w-4 h-4"/>Enter로 제출, 비교 모드는 기호 선택</div>
              </div>
            </CardContent>
          </Card>

          {/* 설정 패널 */}
          <Card className="bg-white/5 border-white/10">
            <CardHeader className="pb-2">
              <CardTitle className="flex items-center gap-2"><Settings className="w-5 h-5"/>설정</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4 text-sm">
              <div>
                <div className="mb-1 text-slate-300">모드</div>
                <Select value={settings.mode} onValueChange={(v: Mode) => setSettings(s => ({...s, mode: v}))}>
                  <SelectTrigger className="w-full"><SelectValue /></SelectTrigger>
                  <SelectContent>
                    <SelectItem value="mixed">혼합</SelectItem>
                    <SelectItem value="arithmetic">사칙연산</SelectItem>
                    <SelectItem value="multiplication">구구단</SelectItem>
                    <SelectItem value="compare">비교(>,<,=)</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div>
                <div className="mb-1 text-slate-300">수 범위 (최댓값: {settings.range})</div>
                <Slider value={[settings.range]} min={10} max={999} step={1} onValueChange={([v]) => setSettings(s => ({...s, range: v}))} />
              </div>

              <div className="flex items-center justify-between">
                <div className="text-slate-300">뺄셈 음수 허용</div>
                <Switch checked={settings.allowNegative} onCheckedChange={(v) => setSettings(s => ({...s, allowNegative: v}))} />
              </div>

              <Separator className="bg-white/10" />

              <div className="flex items-center justify-between">
                <div className="text-slate-300">문제당 시간 제한</div>
                <Switch checked={settings.timeLimit} onCheckedChange={(v) => setSettings(s => ({...s, timeLimit: v}))} />
              </div>
              {settings.timeLimit && (
                <div>
                  <div className="mb-1 text-slate-300">초(문제당): {settings.secondsPerQ}s</div>
                  <Slider value={[settings.secondsPerQ]} min={5} max={60} step={1} onValueChange={([v]) => setSettings(s => ({...s, secondsPerQ: v}))} />
                </div>
              )}

              <div className="flex items-center justify-between">
                <div className="text-slate-300">즉시 채점 (정답이면 자동 다음)</div>
                <Switch checked={settings.instantCheck} onCheckedChange={(v) => setSettings(s => ({...s, instantCheck: v}))} />
              </div>

              <div>
                <div className="mb-1 text-slate-300">세트 문제 수: {settings.questionCount} (표시용)</div>
                <Slider value={[settings.questionCount]} min={5} max={50} step={1} onValueChange={([v]) => setSettings(s => ({...s, questionCount: v}))} />
              </div>
            </CardContent>
          </Card>
        </div>

        {/* 히스토리 탭 */}
        <Card className="bg-white/5 border-white/10">
          <CardHeader>
            <CardTitle>기록 & 오답노트</CardTitle>
          </CardHeader>
          <CardContent>
            <Tabs defaultValue="history">
              <TabsList className="mb-4">
                <TabsTrigger value="history">기록</TabsTrigger>
                <TabsTrigger value="wrong">오답노트</TabsTrigger>
              </TabsList>
              <TabsContent value="history">
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="text-slate-300">
                      <tr className="border-b border-white/10">
                        <th className="text-left p-2">#</th>
                        <th className="text-left p-2">문제</th>
                        <th className="text-left p-2">내 답</th>
                        <th className="text-left p-2">정답</th>
                        <th className="text-left p-2">정오</th>
                        <th className="text-left p-2">시간(s)</th>
                        <th className="text-left p-2">시각</th>
                      </tr>
                    </thead>
                    <tbody>
                      {history.slice(0, 200).map((h, i) => (
                        <tr key={h.id+"_"+i} className="border-b border-white/5 hover:bg-white/5">
                          <td className="p-2">{history.length - i}</td>
                          <td className="p-2 font-mono">{h.text}</td>
                          <td className="p-2">{String(h.user)}</td>
                          <td className="p-2">{String(h.answer)}</td>
                          <td className="p-2">{h.correct? <span className="text-emerald-300">O</span> : <span className="text-rose-300">X</span>}</td>
                          <td className="p-2">{(h.timeMs/1000).toFixed(1)}</td>
                          <td className="p-2">{new Date(h.ts).toLocaleString()}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </TabsContent>
              <TabsContent value="wrong">
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="text-slate-300">
                      <tr className="border-b border-white/10">
                        <th className="text-left p-2">#</th>
                        <th className="text-left p-2">문제</th>
                        <th className="text-left p-2">내 답</th>
                        <th className="text-left p-2">정답</th>
                        <th className="text-left p-2">시간(s)</th>
                        <th className="text-left p-2">다시 풀기</th>
                      </tr>
                    </thead>
                    <tbody>
                      {wrongbook.slice(0, 200).map((h, i) => (
                        <tr key={h.id+"_w_"+i} className="border-b border-white/5 hover:bg-white/5">
                          <td className="p-2">{wrongbook.length - i}</td>
                          <td className="p-2 font-mono">{h.text}</td>
                          <td className="p-2">{String(h.user)}</td>
                          <td className="p-2">{String(h.answer)}</td>
                          <td className="p-2">{(h.timeMs/1000).toFixed(1)}</td>
                          <td className="p-2">
                            <Button size="sm" variant="secondary" onClick={() => {
                              const p: Problem = {
                                id: makeId(), text: h.text, answer: h.answer, meta: { mode: (String(h.answer) === ">" || String(h.answer) === "<" || String(h.answer) === "=")?"compare":"arithmetic", range: settings.range }
                              } as Problem;
                              setCurrent(p); setInput(""); setRunning(true); startedAtRef.current = Date.now();
                            }}>다시</Button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </TabsContent>
            </Tabs>
          </CardContent>
        </Card>

        <footer className="text-center text-xs text-slate-400 py-4">
          © 2025 Q P • 수업용 깃허브 페이지 배포 OK • 로컬에서 설정/기록 저장
        </footer>
      </div>
    </div>
  );
}
