<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>5학년 2학기 분수의 곱셈</title>
<style>
  :root{ --bg:#0b1020; --card:#121a2f; --fg:#e8eef9; --muted:#a7b6d6; --accent:#7dd3fc; --right:#34d399; --wrong:#f87171; }
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--fg);font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", Segoe UI, Roboto, Helvetica, Arial}
  .wrap{max-width:960px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid #1f2a44;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .p16{padding:16px} .p24{padding:24px} .p32{padding:32px}
  h1,h2,h3{margin:0 0 12px} h1{font-size:28px} h2{font-size:22px} h3{font-size:18px}
  .btn{display:inline-flex;align-items:center;gap:10px;padding:14px 18px;border-radius:12px;border:1px solid #2a3a62;background:#17213b;color:var(--fg);cursor:pointer}
  .btn:hover{filter:brightness(1.05)} .btn:active{transform:translateY(1px)} .btn.primary{background:#1b2950;border-color:#2d4483}
  .btn[disabled]{opacity:.5;pointer-events:none}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 220px}
  input[type=text],select{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #314168;background:#0f1730;color:var(--fg)}
  .center{text-align:center}
  .title{font-weight:800;font-size:26px;letter-spacing:1px}
  .muted{color:var(--muted)}
  .progress{display:flex;align-items:center;justify-content:space-between;margin-top:8px;color:#c6d1ea;font-size:14px}
  .nav-arrows{position:sticky;bottom:0;display:flex;gap:10px;justify-content:space-between;margin-top:16px}
  .arrow{flex:1;display:flex;justify-content:center;align-items:center;height:56px;border-radius:12px;background:#122044;border:1px solid #203363;font-size:18px}
  .qnum{display:inline-flex;align-items:center;justify-content:center;width:34px;height:34px;border-radius:10px;background:#0e1833;border:1px solid #2b3f73;margin-right:8px}
  .choices{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
  .choice{padding:14px 16px;border-radius:12px;border:1px solid #2b3f73;background:#0f1730;cursor:pointer}
  .choice.sel{outline:2px solid var(--accent)}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border-radius:999px;border:1px solid #2b3f73;background:#0f1834;font-size:12px;color:#bfd0ff}
  .fraction-input{display:flex;align-items:center;gap:10px;justify-content:center;margin:12px auto}
  .box{background:#0f1730;border:1px solid #2b3f73;border-radius:10px;padding:8px 10px;min-width:68px;text-align:center;font-size:20px}
  .box.small{min-width:56px}
  .slash{width:16px;text-align:center;opacity:.8}
  .keypad{position:sticky;bottom:0;background:#0a1228;border:1px solid #203363;border-radius:14px;margin-top:14px;padding:10px}
  .grid{display:grid;gap:8px}
  .grid.num{grid-template-columns:repeat(5,1fr)}
  .kbtn{height:52px;border-radius:10px;border:1px solid #2b3f73;background:#0f1730;color:var(--fg);font-size:18px}
  .kbtn.wide{grid-column:span 2}
  table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid #23345f}
  .sticky-top{position:sticky;top:0;background:linear-gradient(180deg, rgba(11,16,32,1) 0%, rgba(11,16,32,.92) 70%, rgba(11,16,32,0) 100%);padding-top:12px;margin-top:-12px;z-index:5}
  @media (min-width:720px){.choices{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
  <div class="wrap">
    <header class="p16" style="display:flex;align-items:center;justify-content:space-between">
      <div class="title">5학년 2학기 분수의 곱셈</div>
      <div class="pill">태블릿 최적화 • 오프라인 사용 가능</div>
    </header>
    <main id="app" class="p16"></main>
  </div>
<script>
// ----- 간단 헬퍼 (Array.flat() 비사용) -----
const $ = sel => document.querySelector(sel);
const h = (tag, attrs={}, ...children) => {
  const el = document.createElement(tag);
  for (const k in attrs){
    if(k==='class') el.className=attrs[k];
    else if(k.startsWith('on') && typeof attrs[k]==='function') el.addEventListener(k.slice(2), attrs[k]);
    else if(k==='html') el.innerHTML=attrs[k];
    else el.setAttribute(k, attrs[k]);
  }
  const appendChild = (c)=>{ if(c==null) return; if(Array.isArray(c)) c.forEach(appendChild); else el.append(c instanceof Node? c : document.createTextNode(String(c))); };
  children.forEach(appendChild);
  return el;
};

function gcd(a,b){ a=Math.abs(a); b=Math.abs(b); while(b){ [a,b]=[b,a%b]; } return a||1; }
function toImproper(whole, num, den){ whole=Number(whole||0); num=Number(num||0); den=Number(den||0); if(!den) return null; const n = Math.abs(whole)*den + Math.abs(num); const sign = (whole<0||num<0)?-1:1; return [sign*n, den]; }
function reduce(n,d){ if(d===0) return null; const g=gcd(n,d); const nn = d<0? -n: n; const dd = Math.abs(d); const g2=gcd(nn,dd); return [nn/g2, dd/g2]; }
function parseFractionInput(obj){ const {whole,num,den}=obj; if((den===''||den==null) && (num===''||num==null)){ if(whole===''||whole==null) return null; return [Number(whole),1]; } if(!den || Number(den)===0) return null; const [n,d]=toImproper(whole||0, num||0, den||1); if(n==null) return null; return reduce(n,d); }
function fracEq(a,b){ return a[0]===b[0] && a[1]===b[1]; }
function fracStr([n,d]){ if(d===1) return String(n); const sign = n<0?'-':''; const nn=Math.abs(n); const whole = Math.floor(nn/d); const rem = nn % d; if(whole>0 && rem>0) return `${sign}${whole} ${rem}/${d}`; if(whole>0 && rem===0) return `${sign}${whole}`; return `${sign}${nn}/${d}`; }
function toNormFraction(v){
  if(typeof v==='string'){
    const s=v.trim();
    if(s.includes('/')){ const [a,b]=s.split('/').map(Number); return reduce(a,b); }
    if(/^[-+]?\d+(\.\d+)?$/.test(s)){ const n=Number(s); return [n,1]; }
  }
  if(typeof v==='number'){
    const s=v.toString(); if(!s.includes('.')) return [v,1];
    const digits=s.split('.')[1].length; const den=10**Math.min(4,digits);
    return reduce(Math.round(v*den), den);
  }
  if(Array.isArray(v)) return reduce(v[0], v[1]);
  return null;
}

// ----- 문제 세트 -----
const QUESTIONS = [
  {id:1,  type:'fraction', text:'1) 7 × 5/6 (정답은 기약분수로)', correct:'35/6'},
  {id:2,  type:'fraction', text:'2) 5/8 × 4/9 (정답은 기약분수로)', correct:'5/18'},
  {id:3,  type:'fraction', text:'3) 2 1/3 × 3 1/2 (정답은 기약분수로)', correct:'49/6'},
  {id:4,  type:'fraction', text:'4) 9/10 × 2/3 (정답은 기약분수로)', correct:'3/5'},
  {id:5,  type:'fraction', text:'5) 1 3/5 × 5/8 (정답은 기약분수로)', correct:'1'},
  {id:6,  type:'fraction', text:'6) 2/3 × 3/4 × 4/5 (정답은 기약분수로)', correct:'2/5'},
  {id:7,  type:'fraction', text:'7) 7/9 × 9/14 × 2/3 (정답은 기약분수로)', correct:'1/3'},
  {id:8,  type:'mc', text:'8) 계산이 잘못된 식을 고르세요.', choices:["2/3 × 6 = 4","6 × 2/3 = 3","5/6 × 12 = 10","4/5 × 15 = 12"], answer:0},
  {id:9,  type:'mc', text:'9) 3/5 × □ = 9/10 에서 □ ?', choices:["1 1/2","1 2/3","1 3/4","2"], answer:1},
  {id:10, type:'mc', text:'10) 6의 5/8과 다른 수를 고르세요.', choices:["6 × 5/8","3/4 × 5","5/8 × 6","3/5 × 6"], answer:3},
  {id:11, type:'sign', text:'11) 3 × 3/5 ○ 4 × 2/5', choices:[">","=","<"], answer:1},
  {id:12, type:'mc', text:'12) 3/5 × □ < 2 1/2, 가능한 자연수 개수?', choices:["3","4","5","6"], answer:1},
  {id:13, type:'mc', text:'13) 리본 20m의 3/5 사용. 길이는?', choices:["10","11","12","13","14"], answer:2},
  {id:14, type:'mc', text:'14) 1kg로 2/3kg 빵. 밀가루 8kg로 몇 개?', choices:["10","11","12","13"], answer:2},
  {id:15, type:'mc', text:'15) 달 중력은 지구의 1/6. 72kg → ?', choices:["10","12","14","18"], answer:1},
  {id:16, type:'mc', text:'16) 18쪽의 2/3 읽음. 남은 쪽수?', choices:["4","5","6","7"], answer:2},
  {id:17, type:'mc', text:'17) 한 상자 1 1/3kg 귤 × 6상자 = ?', choices:["7","8","8 1/2","9"], answer:1},
  {id:18, type:'mc', text:'18) 2L의 3/8 마심 → 남은 것의 2/3를 친구에게 줌. 준 양은?', choices:["1/2 L","3/5 L","5/6 L","4/5 L"], answer:2},
  {id:19, type:'mc', text:'19) 2시간에 6km 걷는 속도. 1.5시간 동안 거리?', choices:["4","4 1/2","5","5 1/2"], answer:1},
  {id:20, type:'mc', text:'20) 튀어오름 비율 3/5, 높이 4m → 2번째 튀어오른 높이?', choices:["1.44","1.6","1.8","2.0"], answer:0}
];
for(const q of QUESTIONS){ if(q.type==='fraction') q.correct = toNormFraction(q.correct); }

let STATE = { page:'intro', index:0, student:{school:'',grade:'',klass:'',number:'',name:''}, answers:Array(QUESTIONS.length).fill(null), times:Array(QUESTIONS.length).fill(0), startedAt:null };
function save(){ localStorage.setItem('fm_exam_v1', JSON.stringify(STATE)); }
function load(){ const raw=localStorage.getItem('fm_exam_v1'); if(!raw) return; try{ const s=JSON.parse(raw); STATE={...STATE, ...s}; }catch{} }
load();
function startTimer(){ STATE.startedAt=Date.now(); }
function stopTimer(i){ if(STATE.startedAt){ STATE.times[i]+=(Date.now()-STATE.startedAt); STATE.startedAt=null; } }

const app = $('#app');
function render(){ app.innerHTML=''; if(STATE.page==='intro') return renderIntro(); if(STATE.page==='info') return renderInfo(); if(STATE.page==='exam') return renderExam(); if(STATE.page==='review') return renderReview(); }

function renderIntro(){
  const box = h('div',{class:'card p32 center'},
    h('div',{class:'title', html:'5학년 2학기 <b>분수의 곱셈</b>'}),
    h('p',{class:'muted'},'시험 시작 버튼을 누르세요.'),
    h('div',{style:'height:10px'}),
    h('button',{class:'btn primary', type:'button', onClick:()=>{ STATE.page='info'; save(); render(); }},'시험 시작')
  );
  app.append(box);
}

function renderInfo(){
  const f = h('div',{class:'card p24'},
    h('h2',{},'학생 정보 입력'),
    h('div',{class:'row',style:'margin-top:8px'},
      h('div',{class:'col'}, h('label',{},'학교'), h('input',{type:'text',value:STATE.student.school,oninput:e=>{STATE.student.school=e.target.value;save();}})),
      h('div',{class:'col'}, h('label',{},'학년'), h('input',{type:'text',value:STATE.student.grade,oninput:e=>{STATE.student.grade=e.target.value;save();}})),
      h('div',{class:'col'}, h('label',{},'반'), h('input',{type:'text',value:STATE.student.klass,oninput:e=>{STATE.student.klass=e.target.value;save();}})),
      h('div',{class:'col'}, h('label',{},'번호'), h('input',{type:'text',value:STATE.student.number,oninput:e=>{STATE.student.number=e.target.value;save();}})),
      h('div',{class:'col'}, h('label',{},'이름'), h('input',{type:'text',value:STATE.student.name,oninput:e=>{STATE.student.name=e.target.value;save();}})),
    ),
    h('div',{class:'progress'}, h('div',{},'입력 완료 후 시작을 누르세요.'), h('div',{class:'pill'},'총 문항 20')),
    h('div',{style:'height:12px'}),
    h('button',{class:'btn primary', type:'button', onClick:()=>{ STATE.page='exam'; STATE.index=0; startTimer(); save(); render(); }},'시험 시작')
  );
  app.append(f);
}

function renderExam(){
  const i = STATE.index; const q = QUESTIONS[i];
  const head = h('div',{class:'sticky-top'},
    h('div',{class:'card p16'},
      h('div',{}, h('span',{class:'qnum'}, String(i+1)), h('b',{}, q.text)),
      (q.type==='fraction' ? h('div',{class:'muted'},'[안내] 1~7번의 답은 기약분수로 제출하세요.') : null),
      h('div',{class:'progress'}, h('div',{},`진행 ${i+1}/20`), h('div',{}, `${STATE.student.school||''} ${STATE.student.grade||''}-${STATE.student.klass||''} ${STATE.student.number||''} ${STATE.student.name||''}`))
    )
  );

  const body = h('div',{class:'card p24'});
  let answerView = null;
  if(q.type==='mc' || q.type==='sign'){
    const ans = STATE.answers[i];
    const box = h('div',{class:'choices'});
    q.choices.forEach((c,idx)=>{ box.append(h('div',{class:'choice'+(ans===idx?' sel':''), onClick:()=>{ STATE.answers[i]=idx; save(); render(); }}, c)); });
    answerView = box;
  }
  if(q.type==='fraction'){
    const raw = STATE.answers[i] || {whole:'', num:'', den:''};
    answerView = FractionInput(raw, (val)=>{ STATE.answers[i]=val; save(); });
  }
  body.append(answerView||h('div',{},''));

  const nav = h('div',{class:'nav-arrows'},
    h('button',{class:'arrow', type:'button', onClick:()=>{ stopTimer(i); STATE.index=Math.max(0,STATE.index-1); startTimer(); save(); render(); }}, '← 이전'),
    (i===QUESTIONS.length-1 ?
      h('button',{class:'arrow', type:'button', onClick:()=>{ stopTimer(i); STATE.page='review'; save(); render(); }}, '제출') :
      h('button',{class:'arrow', type:'button', onClick:()=>{ stopTimer(i); STATE.index=Math.min(QUESTIONS.length-1,STATE.index+1); startTimer(); save(); render(); }}, '다음 →')
    )
  );
  app.append(head, h('div',{style:'height:10px'}), body, nav, Keypad(i));
}

function renderReview(){
  const results = QUESTIONS.map((q,idx)=>{
    let correct=false, myDisp='', corrDisp='';
    if(q.type==='mc' || q.type==='sign'){
      const my = STATE.answers[idx];
      correct = (my===q.answer);
      myDisp = (my==null?'(무응답)': q.choices[my]);
      corrDisp = q.choices[q.answer];
    } else if(q.type==='fraction'){
      const my = STATE.answers[idx]; const corr = q.correct; corrDisp = fracStr(corr);
      if(my && my.den!=0){ const p = parseFractionInput(my); if(p){ const pr = reduce(p[0],p[1]); correct = fracEq(pr, corr); myDisp = fracStr(pr); } else { myDisp='(무효 입력)'; }
      } else { myDisp='(무응답)'; }
    }
    return {idx, correct, myDisp, corrDisp, time: Math.round((STATE.times[idx]||0)/100)/10};
  });
  const score = results.reduce((s,r)=> s + (r.correct?5:0), 0);

  const box = h('div',{class:'card p24'},
    h('h2',{},'결과 확인'),
    h('div',{class:'row',style:'margin:8px 0'}, h('div',{class:'pill'},`점수 ${score}/100`), h('div',{class:'pill'},`정답 ${results.filter(r=>r.correct).length}/20`), h('div',{class:'pill'}, new Date().toLocaleString('ko-KR')) ),
    h('div',{style:'overflow:auto'},
      h('table',{}, h('thead',{}, h('tr',{}, h('th',{},'번호'), h('th',{},'내 답'), h('th',{},'정답'), h('th',{},'정오'), h('th',{},'시간(s)'))), h('tbody',{}, results.map(r=> h('tr',{}, h('td',{}, String(r.idx+1)), h('td',{}, r.myDisp), h('td',{}, r.corrDisp), h('td',{}, r.correct? 'O':'X'), h('td',{}, String(r.time)) ))) )
    ),
    h('div',{class:'row',style:'margin-top:14px'},
      h('button',{class:'btn', type:'button', onClick:()=>{ STATE.page='exam'; STATE.index=0; save(); render(); }},'돌아가서 확인'),
      h('button',{class:'btn', type:'button', onClick:()=> downloadCSV(results, score) },'CSV 내보내기'),
      h('button',{class:'btn', type:'button', onClick:()=>{ localStorage.removeItem('fm_exam_v1'); location.reload(); }},'초기화')
    )
  );
  app.append(box);
}

function FractionInput(current, onChange){
  const state = { whole: current.whole||'', num: current.num||'', den: current.den||'' };
  const container = h('div',{});
  const label = h('div',{class:'center muted'},'대분수 입력 지원: [정수] [분자]/[분모]');
  const row = h('div',{class:'fraction-input'},
    h('input',{class:'box small', type:'text', inputmode:'numeric', placeholder:'정수', value:state.whole, oninput:e=>{state.whole=e.target.value.replace(/[^0-9-]/g,''); onChange(state);} }),
    h('div',{class:'slash'},''),
    h('input',{class:'box small', type:'text', inputmode:'numeric', placeholder:'분자', value:state.num, oninput:e=>{state.num=e.target.value.replace(/[^0-9]/g,''); onChange(state);} }),
    h('div',{class:'slash'},'—'),
    h('input',{class:'box small', type:'text', inputmode:'numeric', placeholder:'분모', value:state.den, oninput:e=>{state.den=e.target.value.replace(/[^0-9]/g,''); onChange(state);} })
  );
  container.append(label,row);
  return container;
}

function Keypad(qIndex){
  const q = QUESTIONS[qIndex]; if(q.type!=='fraction') return h('div',{});
  const kp = h('div',{class:'keypad'},
    h('div',{class:'grid num'},
      ...['1','2','3','4','5','6','7','8','9','0'].map(v=> h('button',{class:'kbtn', type:'button', onClick:()=> pushNum(v)}, v)),
      h('button',{class:'kbtn', type:'button', onClick:()=> focusNext()},'분자↔분모'),
      h('button',{class:'kbtn', type:'button', onClick:()=> doReduce()},'약분'),
      h('button',{class:'kbtn', type:'button', onClick:()=> backspace()},'←'),
      h('button',{class:'kbtn', type:'button', onClick:()=> clearAll()},'지우기'),
      h('button',{class:'kbtn wide', type:'button', onClick:()=> goNext()},'확인')
    )
  );
  function getCur(){ return STATE.answers[qIndex] || {whole:'',num:'',den:''}; }
  function setCur(v){ STATE.answers[qIndex]=v; save(); render(); }
  function pushNum(d){ const v={...getCur()}; if(v.num==='') v.num=d; else if(v.den==='') v.den=(v.den||'')+d; else v.whole=(v.whole||'')+d; setCur(v); }
  function focusNext(){ const v={...getCur()}; if(v.num===''){} else if(v.den===''){} setCur(v); }
  function backspace(){ const v={...getCur()}; if(v.den){ v.den=v.den.slice(0,-1); } else if(v.num){ v.num=v.num.slice(0,-1); } else if(v.whole){ v.whole=v.whole.slice(0,-1); } setCur(v); }
  function clearAll(){ setCur({whole:'',num:'',den:''}); }
  function doReduce(){ const p=parseFractionInput(getCur()); if(!p){ alert('분수 입력을 확인하세요.'); return; } const r=reduce(p[0],p[1]); const nn=Math.abs(r[0]); const w=Math.floor(nn/r[1]); const rem=nn%r[1]; const sign=r[0]<0?'-':''; STATE.answers[qIndex]={whole:(sign?(sign+w):String(w)), num:String(rem), den:String(r[1])}; save(); render(); }
  function goNext(){ const p=parseFractionInput(getCur()); if(!p){ alert('정수/분자/분모를 확인해주세요.'); return; } const r=reduce(p[0],p[1]); STATE.answers[qIndex]={whole:'', num:String(r[0]), den:String(r[1])}; save(); stopTimer(qIndex); STATE.index=Math.min(QUESTIONS.length-1, STATE.index+1); startTimer(); render(); }
  return kp;
}

function downloadCSV(results, score){
  const head = ['no','type','my_answer','correct','correctYN','time_s'];
  const rows = results.map((r,i)=>[i+1, QUESTIONS[i].type, r.myDisp, r.corrDisp, r.correct?'O':'X', r.time]);
  rows.unshift(head);
  const csv = rows.map(r=> r.map(x=> '"'+String(x).replace(/"/g,'""')+'"').join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='fraction_exam_results.csv'; a.click(); URL.revokeObjectURL(url);
}

render();
</script>
</body>
</html>
